---
title: "hw8"
author: "Due: 11:59pm Saturday 8/6/2016.  Instructors stop answering questions at 5pm."
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(dplyr)
library(ggplot2)
library(purrr)
library(stringr)
library(animation)
library(RSQLite) 
library(animation)
library(tidyr)
setwd("~/Desktop/Stats R/githubrepos-jennyjiang95/hw8")
```

### purrr

In this exercise, you'll be using functional programming ideas to simulate the central limit theorem on coin flips.  Using neither loops nor the apply functions, write a simulation pipeline that:

* Generates 1000 samples of each 1, 2, ..., 99, 100 fair coin flips.  So for example, you would simulate flipping 1 coins 1000 times, 2 coins 1000 times, etc.
* For each of the 1, 2, ..., 100 flips, produces a histogram of the proportion of heads.  To be explicit: you will create a histogram for the 1000 proportions calculated from the 1 coin flips.  Then you'll do the same for 2 coin flips, 3, etc.

In your plots
* The x-axis should be limited to 0-1
* The y-axis should be limited to 0-15


```{r}
##function to generate samples
proportion = function(n){
  sample = sample(c(1,0),
                  size=n,
                  replace=T)
  proportion = sum(sample)/n
  return(proportion)
}
#run it 1000 times for 100 coins
df = map(1:100, 
         function(x) 
           rerun(1000,proportion(x)))
## generate the plots

generate_plot = function(n){
  set=data.frame(df[[n]]) %>% 
    gather(key=x,
           value=outcome) %>% 
    mutate(x=c(1:1000))
  
  graph = ggplot(set,
               aes(outcome,
                   y=..density..))+
    geom_histogram(bins=30)+
    scale_x_discrete(limits=c(0,1))+
    scale_y_continuous(limits=c(0,15))+
    labs(list(title = str_c("The", x, "coins"),
            x = "prop",
            y = "frequency"))
  
  ggsave(graph,file=str_c("plot",str_pad(n, width=3, pad="0", side= "left"), ".png" ,sep=""),
         path="~/Desktop/Stats R/githubrepos-jennyjiang95/hw8/plots",
         device="png")
}

# create and save 100 plots
c(1:100) %>% 
  map(generate_plot)

# produce gif
file_names = str_c("plot", str_pad(c(1:100), width=3,pad="0", side="left"),".png",sep="")
im.convert(file_names,output= "test.gif")

# ANOTHER WAY
system("convert -delay 5 -loop 0 *.png proportion.gif")

```

Now that you have all the static images, you could "animate" the progression by turning the sequence of images into a gif.  This can be achieved with the `animation` package in R or the standalone `ImageMagick` utility.  This is just an FYI, we will not be looking for a GIF.  Also, Please do NOT upload the images to GitHub nor bCourses.  We'll just be checking your code.

## SQL

These exercises are meant to help you wrap your head around SQL.  Answer the questions below using SQL queries.  You can check your answer using `dplyr` methods, but your grade will be based on the SQL commands.  The `nycflights13` data set has been put into a SQLlite database for these problems.  For documentation about the variable names, see

```{r, eval = FALSE}
help(package = "nycflights13")
```

```{r}
flights <- src_sqlite("nycflights13.mysqlite3")

answer <- readRDS("hw8_sql_results.rds")


#nyairlines
    #carrier; name
#nyairports
    #faa; name; lat,lat; alt; tz(time zone); dst(daylight savings time zone)
#nyflights
    #year,month,day; dep_time,arr_time; sched_dep_time,sched_arr_time; dep_delay,arr_delay, 
    #hour,minute; carrier; tailnum; flight; origin,dest; air_time; distance; time_hour
#nyplanes
    #tailnum; year; type; manufacturer,model; engines,seats; speed; engine
#nyweather
    #origin; year,month,day,hour; temp,dewp; humid; wind_dir,wind_speed,wind_gust; precip; pressure;
    #visib; time_hour

```


1. Find the full name of each airline that flew to Dallas Fort-Worth (DFW).
```{r}
flights %>% tbl(sql("
  SELECT
    DISTINCT nyairlines.name
  FROM
    nyflights
    LEFT JOIN nyairlines on nyairlines.carrier = nyflights.carrier
  WHERE
     nyflights.dest = 'DFW'
"))

```


2. Make a table containing the tail number, year of manufacture, model, number of engines, and number of seats of the planes flown by United Airlines (UA).  Sort the results by year manufactured.

```{r}
flights %>% tbl(sql("
  SELECT 
    DISTINCT nyplanes.tailnum,
    nyplanes.year,
    nyplanes.model,
    nyplanes.engines,
    nyplanes.seats
  FROM 
    nyplanes,
    nyflights
  WHERE  
    nyplanes.tailnum = nyflights.tailnum
    AND nyflights.carrier = 'UA'
  ORDER BY 
    nyplanes.year ASC
")) %>% 
  collect

```


3. Make a table with the following information: full airport name in a column called `Airport` and number of flights from New York City to those airports in 2013 in a column called `NumberOfFlights`.  Sort the results in descending order by flight counts.

```{r}
flights %>% tbl(sql("  
  SELECT
    nyairports.name as Airport,
    count(*) as NumberOfFlights
  FROM 
    nyflights,
    nyairports
  WHERE
    nyflights.year = '2013'
    AND nyairports.faa = nyflights.dest
  GROUP BY
    nyairports.name
  ORDER BY
    count(*) DESC
")) %>% 
  collect
```


4. Find the wind speed during the hour of the sceduled departure time of every flight that had a departure delay of more than 30 minutes.  For example, if a flight was scheduled to leave at 5:59am, you would check the wind speed for 5:00am.  In practice, you would of course be more careful than this.

```{r}
flights %>% tbl(sql("  
  SELECT
    nyweather.wind_speed,
    nyweather.hour,
    nyweather.time_hour
  FROM 
    nyflights,
    nyweather
  WHERE
    nyflights.dep_delay > 30
    AND nyweather.origin = nyflights.origin
    AND nyweather.time_hour = nyflights.time_hour
")) %>% 
  collect
```